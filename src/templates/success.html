<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authentication Successful</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 16px;
        padding: 3rem 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 600px;
        width: 100%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #28a745, #20c997);
      }

      .icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
        width: 128px;
        height: 128px;
        animation: bounceIn 0.6s ease-out;
      }

      .title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1rem;
      }

      .message {
        color: #718096;
        font-size: 1rem;
        line-height: 1.5;
        margin-bottom: 1.5rem;
      }

      .token-section {
        margin-top: 1.5rem;
        width: 100%;
      }

      .token-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 0.5rem;
        display: block;
        text-align: left;
      }

      .token-container {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        overflow: hidden;
      }

      .token-header {
        background: #f1f3f4;
        border-bottom: 1px solid #e9ecef;
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: #495057;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
      }

      .token-header:hover {
        background: #e9ecef;
      }

      .token-header-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .token-header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .toggle-button {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .toggle-button:hover {
        background: #dee2e6;
        color: #495057;
      }

      .toggle-icon {
        width: 16px;
        height: 16px;
        transition: transform 0.2s ease;
      }

      .toggle-icon.expanded {
        transform: rotate(180deg);
      }

      .token-display {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 0.75rem;
        word-break: break-all;
        background: #f8f9fa;
        color: #495057;
        padding: .5rem;
        border: none;
        max-height: 150px;
        overflow-y: auto;
        line-height: 1.4;
        margin: 0;
        transition: max-height 0.3s ease, opacity 0.3s ease;
      }

      .token-display.collapsed {
        max-height: 0;
        opacity: 0;
        padding: 0 .5rem;
        overflow: hidden;
      }

      .token-preview {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 0.75rem;
        color: #6c757d;
        padding: .5rem;
        background: #f8f9fa;
        font-style: italic;
        border: none;
        margin: 0;
        transition: max-height 0.3s ease, opacity 0.3s ease;
      }

      .token-preview.hidden-preview {
        max-height: 0;
        opacity: 0;
        padding: 0 .5rem;
        overflow: hidden;
      }

      .copy-button {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .copy-button:hover {
        background: #5a6268;
        transform: translateY(-1px);
      }

      .copy-button:active {
        transform: translateY(0);
      }

      .copy-button.copied {
        background: #38a169;
      }

      .copy-icon {
        width: 14px;
        height: 14px;
      }

      .hidden {
        display: none !important;
      }

      @keyframes bounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(1.05);
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 2rem 1.5rem;
        }
        .title {
          font-size: 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
          <path
            fill="#28a745"
            d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM404.4 276.7L324.4 404.7C320.2 411.4 313 415.6 305.1 416C297.2 416.4 289.6 412.8 284.9 406.4L236.9 342.4C228.9 331.8 231.1 316.8 241.7 308.8C252.3 300.8 267.3 303 275.3 313.6L302.3 349.6L363.7 251.3C370.7 240.1 385.5 236.6 396.8 243.7C408.1 250.8 411.5 265.5 404.4 276.8z"
          />
        </svg>
      </span>
      <h1 class="title">Authentication Successful!</h1>
      <p class="message">
        You can now close this browser window and return to the terminal.
      </p>
      
      <div class="token-section" id="tokenSection">
        <!-- Access Token -->
        <div class="token-container">
          <div class="token-header" onclick="toggleTokenDisplay('access')" onkeydown="handleTokenHeaderKeydown(event, 'access')" tabindex="0" role="button" aria-expanded="false" aria-controls="accessTokenDisplay" aria-label="Toggle access token visibility">
            <div class="token-header-left">
              <span>Access Token</span>
              <button class="toggle-button" tabindex="-1">
                <svg class="toggle-icon" id="accessToggleIcon" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            <div class="token-header-right">
              <button class="copy-button" id="accessCopyButton" onclick="copyToken(event, 'access')">
                <svg class="copy-icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                  <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                </svg>
                <span id="accessCopyText">Copy</span>
              </button>
            </div>
          </div>
          <div class="token-preview" id="accessTokenPreview">Click to view access token</div>
          <div class="token-display collapsed" id="accessTokenDisplay">{access_token}</div>
        </div>

        <!-- ID Token -->
        <div class="token-container" id="idTokenContainer" style="display: none;">
          <div class="token-header" onclick="toggleTokenDisplay('id')" onkeydown="handleTokenHeaderKeydown(event, 'id')" tabindex="0" role="button" aria-expanded="false" aria-controls="idTokenDisplay" aria-label="Toggle ID token visibility">
            <div class="token-header-left">
              <span>ID Token</span>
              <button class="toggle-button" tabindex="-1">
                <svg class="toggle-icon" id="idToggleIcon" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            <div class="token-header-right">
              <button class="copy-button" id="idCopyButton" onclick="copyToken(event, 'id')">
                <svg class="copy-icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                  <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                </svg>
                <span id="idCopyText">Copy</span>
              </button>
            </div>
          </div>
          <div class="token-preview" id="idTokenPreview">Click to view ID token</div>
          <div class="token-display collapsed" id="idTokenDisplay">{id_token}</div>
        </div>

        <!-- Refresh Token -->
        <div class="token-container" id="refreshTokenContainer" style="display: none;">
          <div class="token-header" onclick="toggleTokenDisplay('refresh')" onkeydown="handleTokenHeaderKeydown(event, 'refresh')" tabindex="0" role="button" aria-expanded="false" aria-controls="refreshTokenDisplay" aria-label="Toggle refresh token visibility">
            <div class="token-header-left">
              <span>Refresh Token</span>
              <button class="toggle-button" tabindex="-1">
                <svg class="toggle-icon" id="refreshToggleIcon" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            <div class="token-header-right">
              <button class="copy-button" id="refreshCopyButton" onclick="copyToken(event, 'refresh')">
                <svg class="copy-icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                  <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                </svg>
                <span id="refreshCopyText">Copy</span>
              </button>
            </div>
          </div>
          <div class="token-preview" id="refreshTokenPreview">Click to view refresh token</div>
          <div class="token-display collapsed" id="refreshTokenDisplay">{refresh_token}</div>
        </div>
      </div>
    </div>
    
    <script>
      const tokenSection = document.getElementById('tokenSection');
      
      // Token data storage
      let tokens = {
        access_token: '{access_token}',
        id_token: '{id_token}',
        refresh_token: '{refresh_token}'
      };
      
      // Expansion state for each token type
      let expandedStates = {
        access: false,
        id: false,
        refresh: false
      };
      
      // Initialize display
      initializeTokenDisplay();
      
      function initializeTokenDisplay() {
        // Check if any tokens are available
        const hasAccessToken = tokens.access_token && tokens.access_token !== '{access_token}';
        const hasIdToken = tokens.id_token && tokens.id_token !== '{id_token}';
        const hasRefreshToken = tokens.refresh_token && tokens.refresh_token !== '{refresh_token}';
        
        if (!hasAccessToken && !hasIdToken && !hasRefreshToken) {
          tokenSection.style.display = 'none';
          pollForTokens();
        } else {
          tokenSection.style.display = 'block';
          
          // Show/hide token containers based on availability
          if (hasIdToken) {
            document.getElementById('idTokenContainer').style.display = 'block';
            updateTokenPreview('id', tokens.id_token);
          }
          if (hasRefreshToken) {
            document.getElementById('refreshTokenContainer').style.display = 'block';
            updateTokenPreview('refresh', tokens.refresh_token);
          }
          if (hasAccessToken) {
            updateTokenPreview('access', tokens.access_token);
          }
        }
      }
      
      function toggleTokenDisplay(tokenType) {
        expandedStates[tokenType] = !expandedStates[tokenType];
        
        const tokenDisplay = document.getElementById(`${tokenType}TokenDisplay`);
        const tokenPreview = document.getElementById(`${tokenType}TokenPreview`);
        const toggleIcon = document.getElementById(`${tokenType}ToggleIcon`);
        const tokenHeader = document.querySelector(`[aria-controls="${tokenType}TokenDisplay"]`);
        
        if (expandedStates[tokenType]) {
          tokenDisplay.classList.remove('collapsed');
          tokenPreview.classList.add('hidden-preview');
          toggleIcon.classList.add('expanded');
          tokenHeader.setAttribute('aria-expanded', 'true');
        } else {
          tokenDisplay.classList.add('collapsed');
          tokenPreview.classList.remove('hidden-preview');
          toggleIcon.classList.remove('expanded');
          tokenHeader.setAttribute('aria-expanded', 'false');
        }
      }
      
      function handleTokenHeaderKeydown(event, tokenType) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          toggleTokenDisplay(tokenType);
        }
      }
      
      async function pollForTokens() {
        let attempts = 0;
        const maxAttempts = 30;
        
        const poll = async () => {
          if (attempts >= maxAttempts) {
            return;
          }
          
          try {
            const response = await fetch('/tokens');
            if (response.ok) {
              const data = await response.json();
              if (data.access_token || data.id_token || data.refresh_token) {
                updateTokensFromResponse(data);
                tokenSection.style.display = 'block';
                return;
              }
            }
          } catch (error) {
            console.log('Polling for tokens...', error);
          }
          
          attempts++;
          setTimeout(poll, 500);
        };
        
        poll();
      }
      
      function updateTokensFromResponse(data) {
        if (data.access_token) {
          tokens.access_token = data.access_token;
          document.getElementById('accessTokenDisplay').textContent = data.access_token;
          updateTokenPreview('access', data.access_token);
        }
        
        if (data.id_token) {
          tokens.id_token = data.id_token;
          document.getElementById('idTokenDisplay').textContent = data.id_token;
          document.getElementById('idTokenContainer').style.display = 'block';
          updateTokenPreview('id', data.id_token);
        }
        
        if (data.refresh_token) {
          tokens.refresh_token = data.refresh_token;
          document.getElementById('refreshTokenDisplay').textContent = data.refresh_token;
          document.getElementById('refreshTokenContainer').style.display = 'block';
          updateTokenPreview('refresh', data.refresh_token);
        }
      }
      
      function updateTokenPreview(tokenType, token) {
        const tokenPreview = document.getElementById(`${tokenType}TokenPreview`);
        const tokenName = tokenType === 'access' ? 'access token' : 
                         tokenType === 'id' ? 'ID token' : 'refresh token';
        
        if (token && token.length > 20) {
          tokenPreview.textContent = `${token.substring(0, 20)}... (click to view full ${tokenName})`;
        } else if (token) {
          tokenPreview.textContent = `Click to view ${tokenName}`;
        }
      }
      
      async function copyToken(event, tokenType) {
        event.stopPropagation(); // Prevent triggering toggle when clicking copy
        
        const copyButton = document.getElementById(`${tokenType}CopyButton`);
        const copyText = document.getElementById(`${tokenType}CopyText`);
        const token = tokens[tokenType === 'access' ? 'access_token' : 
                            tokenType === 'id' ? 'id_token' : 'refresh_token'];
        
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(token);
          } else {
            const textArea = document.createElement('textarea');
            textArea.value = token;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
          }
          
          copyButton.classList.add('copied');
          copyText.textContent = 'Copied!';
          
          setTimeout(() => {
            copyButton.classList.remove('copied');
            copyText.textContent = 'Copy';
          }, 2000);
          
        } catch (err) {
          console.error('Failed to copy token:', err);
          copyText.textContent = 'Copy failed';
          setTimeout(() => {
            copyText.textContent = 'Copy';
          }, 2000);
        }
      }
    </script>
  </body>
</html>
